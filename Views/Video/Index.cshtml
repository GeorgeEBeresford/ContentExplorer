@{
    ViewBag.Title = "Videos";

    string baseDirectory = ConfigurationManager.AppSettings["VideosPath"];
    string cdn = ConfigurationManager.AppSettings["CDNPath"];

    DirectoryInfo relativeDirectory = ViewBag.Directory;
    int currentPage = ViewBag.Page;
    string filter = ViewBag.Filter;
    string baseSiteDirectory = ConfigurationManager.AppSettings["BaseDirectory"];
    string path = relativeDirectory.FullName.Substring(baseSiteDirectory.Length + baseDirectory.Length + 1).Trim("\\/.".ToCharArray());

    if (path.Length > 1)
    {
        ViewBag.Title = relativeDirectory.Name + " ~ " + ViewBag.Title;
    }
    int videosPerPage = ViewBag.VideosPerPage;
}

@using System.Configuration
@using System.Web.Configuration
@using ContentExplorer.Services
@model ContentExplorer.Models.ViewModels.DirectoryViewModel

@helper RenderThumbnail(string videoFilePath, string videoName, string videoWebPath)
{
    string imageName = string.Format("{0}.jpg", videoName);
    string thumbnailLocation = Path.Combine(videoFilePath, imageName);

    FileInfo thumbnailInfo = new FileInfo(thumbnailLocation);
    if (thumbnailInfo.Exists == false)
    {
        VideoThumbnailService videoThumbnailService = new VideoThumbnailService();
        videoThumbnailService.CreateThumbnail(Path.Combine(videoFilePath, videoName));
    }

    // Replace characters which break css
    string thumbnailWebPath = Path.Combine(videoWebPath, imageName)
        .Replace("\\", "/")
        .Replace("%", "%25")
        .Replace("'", "%27");
    <div style="background-image: url('@thumbnailWebPath'); background-size: cover; width: 100%; height: 100%"></div>
}

@helper RenderDirectory(DirectoryInfo directory, string cdn, string baseDirectory, string path, string baseSiteDirectory)
{
    VideoThumbnailService videoThumbnailService = new VideoThumbnailService();
    FileInfo previewVideo = videoThumbnailService.GetVideoThumbnail(directory);

    string thumbnailPath;

    if (previewVideo != null)
    {
        string relativeWebPath = previewVideo.Directory.FullName.Substring(baseSiteDirectory.Length + baseDirectory.Length + 1).Trim("\\/.".ToCharArray());

        thumbnailPath = Path.Combine(cdn, baseDirectory, relativeWebPath, previewVideo.Name).Replace("\\", "/");
    }
    else
    {
        thumbnailPath = "none";
    }


    // Replace characters which break css
    thumbnailPath = thumbnailPath.Replace("'", "%27");

    <li class="directory_item" style="background-image: url('@thumbnailPath'); background-size: cover">
        <a href="@Url.Action("Index", new {path = Path.Combine(path, directory.Name)})" class="directory_link">
        </a>
        <label class="media_name">
            @directory.Name
            <input type="checkbox" data-tag-selector data-tag-type="directory" data-path="@(directory.FullName)" />
        </label>
    </li>
}

@helper RenderSteppingStones(DirectoryInfo parentDirectory, string baseSiteDirectory, string videoDirectory, int page, string filter)
{


    if (parentDirectory.Parent != null && parentDirectory.Parent.FullName != baseSiteDirectory)
    {
        @RenderSteppingStones(parentDirectory.Parent, baseSiteDirectory, videoDirectory, page, filter)
    }
    <a class="steppingstone_item" href="@Url.Action("Index", new { path = parentDirectory.FullName.Substring(baseSiteDirectory.Length + videoDirectory.Length + 1), page = page, filter = filter })">@(parentDirectory.Name)</a>
}

<input data-directory-name type="hidden" value="@(relativeDirectory.FullName)" />

<nav class="steppingstone_list">
    @RenderSteppingStones(relativeDirectory, baseSiteDirectory, baseDirectory, currentPage, filter)
</nav>

<div class="sidebar">
    <h2>Filters</h2>

    <label for="txtFilter">
        Custom filter
        <input type="text" id="txtFilter" value="@filter" class="input-sm" data-custom-filter />
        <button style="@(filter != "" ? "display: inline-block" : "display: none")" data-clear-filter>X</button>
    </label>
    <button class="btn btn-default" data-apply-filter>Apply Custom Filter</button>

    <ul class="tagList" data-tags-for-folder>
    </ul>

    @if (Model.FileInfos.Any() || Model.DirectoryInfos.Any())
    {
        <h2>Add Tags</h2>
        <label class="input-group">
            Tag Name
            <input class="input-sm" type="text" data-tag-name />
            <button class="btn btn-default" data-add-tag>Add Tags</button>
        </label>
    }
</div>
<div class="content_sidebar">

    @if (Model.DirectoryInfos.Any() || Model.FileInfos.Any())
    {
        <div class="btn-block">
            <a class="btn btn-default" href="@Url.Action("RebuildThumbnails", "Video", new {path = path})" target="_blank">
                <div class="btn btn-default">
                    Rebuild Thumbnails
                </div>
            </a>
            <a class="btn btn-default" href="@Url.Action("ReformatNames", "Video", new {path = path})" target="_blank">
                <div class="btn btn-default">
                    Reformat Names
                </div>
            </a>
            <a class="btn btn-default" href="@Url.Action("ConvertUnplayableVideos", "Video", new {path = path})" target="_blank">
                <div class="btn btn-default">
                    Convert Unplayable Videos
                </div>
            </a>
        </div>

        <div class="btn-block">
            <button class="btn btn-primary" data-select-all>Select All</button>
            <button class="btn btn-default" data-select-none>Select None</button>
        </div>
    }


    @if (Model.DirectoryInfos.Any())
    {
        <h1>Directories</h1>
        <ul class="directory_list">
            @foreach (DirectoryInfo directory in Model.DirectoryInfos)
            {
                @RenderDirectory(directory, cdn, baseDirectory, path, baseSiteDirectory)
            }
        </ul>
    }

    @if (Model.FileInfos.Any())
    {
        int videoNumber = (currentPage - 1) * videosPerPage + 1;

        <h1>Videos</h1>
        <ul class="media_list">

            @for (int videoIndex = 0; videoIndex < Model.FileInfos.Count; videoIndex++)
            {
                FileInfo video = Model.FileInfos.ElementAt(videoIndex);
                string previewPath = video.Directory.FullName.Replace("\\", "/");

                string linkPath = Url.Action("View", new { path = path, page = videoNumber, filter = filter });

                <li class="media_item">
                    <a href="@linkPath" target="_blank" class="media_link">
                        @RenderThumbnail(previewPath, video.Name, Path.Combine(cdn, baseDirectory, path))
                    </a>
                    <label class="media_name">
                        @video.Name
                        <input type="checkbox" data-tag-selector data-tag-type="file" data-path="@(video.FullName)" />
                    </label>
                </li>

                videoNumber++;
            }
        </ul>
    }

    @if (Model.FileInfos.Any() == false && Model.DirectoryInfos.Any() == false)
    {
        <h1>No files found</h1>
    }

    @{
        int maxPages = (int)Math.Ceiling((decimal)Model.FileCount / videosPerPage);
    }

    @if (maxPages > 1)
    {
        <div class="button_wrapper">
            <div class="button_list">
                @for (int pageIndex = 1; pageIndex <= maxPages; pageIndex++)
                {
                    if (pageIndex != currentPage)
                    {
                        <a class="button_item" href="@Url.Action("Index", new { path = relativeDirectory, page = pageIndex, filter = filter })">@pageIndex</a>
                    }
                    else
                    {
                        <div class="button_item-current">@pageIndex</div>
                    }
                }
            </div>
            <div>
                @maxPages Pages total
            </div>
        </div>
    }
</div>

@section scripts {

    @Scripts.Render("~/bundles/video/index")
}